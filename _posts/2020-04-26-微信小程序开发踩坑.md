<!--
 * @Description: 记录微信小程序开发时的踩坑
 * @Author: youzi
 * @Date: 2020-04-26 09:23:48
 * @LastEditors: youzi
 * @LastEditTime: 2020-05-07 18:39:48
 -->

# 微信小程序开发踩坑

基于微信小程序，使用初始小程序云开发模板进行开发；

记录一些组件、API 之类的注意事项；

## 正篇

> 授权相关

授权相关的操作，建议是在需要使用授权接口时，才去向用户发起授权申请，并且要说明理由；除了`wx.authorize({scope: 'scope.userInfo'})`，其他都可以直接从底部拉起授权窗口；所以我们这里主要是讲授权获取用户基本信息这个接口；

由于`wx.getUserInfo()`这个接口改版了，直接调用这个接口不会拉起授权窗口，改成了需要用户手动点击`button`才会从下方弹出授权窗口；下面是一个 demo，和文档里的 demo 差不多；

需要注意的是：我一般喜欢用`button`直接显示用户昵称，所以会选择覆盖默认的按钮样式（要注意`color && background-color`属性用`!important`），且在获取到用户信息后把按钮置为`disable`状态；

```html
<image src="{{ avatarUrl }}"></image>
<!-- 最好覆盖button的默认样式，这样不会在UI上显得很奇怪 -->
<button open-type="getUserInfo" bindgetuserinfo="onGetUserInfo" disabled="{{logged}}">{{userInfo.nickName}}</button>

<!-- js -->
<script>
  data {
    // 用户头像的默认值，一般用于未获取到授权时显示的一个默认灰色的头像
    userInfo: {
      nickName: '点击登录'
    },
    avatarUrl: './default.png',
    // 标志用户是否登录
    logged: false
  }
  // 在load时check一下是否已经获得了用户授权
  onLoad(){
    wx.getSetting({
        success: res => {
          if (res.authSetting['scope.userInfo']) {
            // 已经授权，可以直接调用 getUserInfo 获取头像昵称
            wx.getUserInfo({
              success: res => {
                this.setData({
                  logged: true,
                  avatarUrl: res.userInfo.avatarUrl,
                  userInfo: res.userInfo
                });
              }
            });
          }
        }
      });
  }
  // 获取用户信息
  onGetUserInfo(e) {
    if (!this.data.logged && e.detail.userInfo) {
      this.setData({
        logged: true,
        avatarUrl: e.detail.userInfo.avatarUrl,
        userInfo: e.detail.userInfo
      })
    } else {
      // 如果用户没有授权，可以弹出对话框提示用户需要授权才能使用
    }
  }
</script>
```

补充说明：**如果使用云开发其实不需要用户进行授权，后台都能获取到`openid`等信息**；

补充说明2：如果只想拿到除`openid`以外的一些信息，可以直接用`open-data`这个组件，直接获取，比写授权方便多了。

> 全局 style

- 模板项目的全局配置文件`app.json`中有一个`sytle: 'v2'`的属性，文档描述`微信客户端 7.0 开始，UI 界面进行了大改版。小程序也进行了基础组件的样式升级。app.json 中配置 "style": "v2"可表明启用新版的组件样式`；需要的时候可以把这个去掉，有比较多的样式都会变得不一样。
- 也可以在`app.wxss`文件里，写全局样式加上`!important`去覆盖掉。

> `text`组件

- 内容不要换行，要紧贴标签写内容，因为最开头的换行符会被渲染出来。

```html
<!-- bad -->
<text class="" selectable="false" space="false" decode="false">
  content
</text>

<!-- good -->
<text class="" selectable="false" space="false" decode="false">content</text>
```

> `loading`相关

- 当数据初始化渲染时，可以直接使用 API 控制下拉的`loading`，没必要使用`mp-loading`组件。仅限下拉 loading 能满足需求时使用，其他要使用到组件的还是推荐用组件。

```html
<!-- not recommended -->
<mp-loading duration="{{500}}" ext-class="loading" type="dot-gray" show="{{show}}" animated="{{animated}}"></mp-loading>
<view wx:if="{{!show}}"></view>

<!-- recommend -->
<view wx:if="{{!show}}"></view>
<!-- js -->
<script>
  onRead() {
    wx.startPullDownRefresh();
  },
  onPullDownRefresh() {
    wx.stopPullDownRefresh();
  },
</script>
```

- 另外目前发现了`mp-loading`组件的 bug，设置`type: dot-white`时无法正常渲染；还有就是最好设置`ext-class`并且给一个宽度，有可能会发生只渲染出一个点的情况。

> `mp-form`相关

- 组件内部没有`*`符号标注必填项，一般我会用下面的方法自己写。

```html
<mp-cell prop="name" show-error>
  <view slot="title" class="weui-label">
    必填项
    <text style="color:red">*</text>
  </view>
  <input />
</mp-cell>
```

效果如下图：

![必填项](/img/in-post/mp-trap/input-required.png)

- `input`组件内部没有输入字数统计，写了一个，但是没有写成组件的模式；

`html`

```html
<input
  type="text"
  data-field="name"
  class="weui-input"
  placeholder="{{ '最多' + nameMaxLength + '个字符' }}"
  bindinput="formInputChange"
  value="{{ formData.name }}"
  maxlength="{{ nameMaxLength }}"
/>
<view slot="footer" class="ext-footer">{{ nameLength }}/{{ nameMaxLength }}字</view>
```

`css`

```css
.ext-footer {
  display: inline-block;
  padding-right: 10rpx;
  vertical-align: middle;
}
```

`js`

```js
if (field === 'name') {
  this.setData({
    nameLength: val.length,
    [`formData.${field}`]: val
  });
}
```

效果如下图：

![字符计数](/img/in-post/mp-trap/input-char-count.png)

- 关于`form`的校验，只要写了`rules`，那么在输入任何一项时都会触发表单的校验，感觉有点鸡肋，触发频率太高了，所以建议使用防抖函数来规避在输入时一直触发校验函数的问题。

- `input`标签一般可以不写`value`属性，在文档中`input`的`value`被定义为输入框的初始值，所以可以不写，但是由于微信的值不是双向绑定的，所以需要写`bindinput`事件函数，来手动改变`data`里面的值；

> 路径相关

- 在`json`文件里，可以直接用`/`表示小程序根目录(miniprogram)；而在`js`文件中应该要使用*相对路径*来引入文件；目前看到在`wxml`文件里可以用`/`表示根目录；最好的方法建议是都使用相对路径，目前还没有发现相对路径会出现什么问题
