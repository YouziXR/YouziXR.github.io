---
layout: post
title: '在JS中实例化Vue的组件'
date: 2021-04-02
author: 'Youzi'
catalog: true
tags:
  - JS
  - Vue
---

# JS 中实例化 Vue 组件

近期在写封装组件的时候，写了 dialog，搜了一下很多开源组件库的很多这类组件都支持直接使用 JS 调用组件，稍微研究了下这些组件的源码，记录一下相关的方法；

> 本文设计 Vue2.x 和 3.0 的两种方式，由于 3.0 去掉了很多 api，在写的时候也遇到了一些问题，同步记录一下；

## JS 调用 Vue 组件的方式

在 JS 文件中，直接引入`xx.vue`文件，得到的是一个组件对象，等会在示例代码里面会输出来看看；接下来要借助`Vue`提供的一些工具函数，来将一个组件对象，改造成`VNode`对象；最后再将`VNode`对象渲染成真实的`DOM`对象，插入到 DOM 树中；

光看着上面这段描述，可能还是一头雾水，其实这个过程和·Vue·项目里的·main.js·做的事是一样的，我们来看普通项目中`main.js`做了什么（项目用 Vue2.x 的 template 项目做演示）：

```js
import Vue from 'vue';
import App from './App.vue';
// 引入Vue，引入App组件，这里我们把App打印出来看看；
console.warn(App); // object...

Vue.config.productionTip = false;

new Vue({
  render: h => h(App)
}).$mount('#app');
```

引入 App 组件后，·new Vue·会为我们实例化一个·Vue·的实例，然后链式调用了·Vue·实例上的·$mount()·方法；而实例化的参数是一个对象，对象内包含一个`render`属性，是一个函数，这个函数又接收了·h·函数，·h·函数的参数是组件对象；

### `new Vue`的参数

大概梳理完了之后，我们来细说每个部分；首先是`new Vue`：

- 实例化一个 Vue 对象，接受一个对象作为参数，而对象内部所包含的属性在文档里的[Vue 实例所有的选项](https://cn.vuejs.org/v2/api/#data)；
- 所有的选项除了[选项/DOM](https://cn.vuejs.org/v2/api/#%E9%80%89%E9%A1%B9-DOM)不常用以外，其他都是写 Vue 组件经常用到的；着重说说这几个：
  - ·el·：指定组件挂载的 DOM 元素，只在·new Vue·的时候生效，也就是说上面的`main.js`也可以改写成`new Vue({el: document.querySelector('#app')})`，只是此时`<div id="app"></div>`会被覆盖；
  - ·render·：render 函数如果经常用·js·写组件的话应该不陌生，该函数的参数是一个·h·函数（函数内部接受一个 Vue 组件对象，并返回由该组件对象生成的 VNode 对象），render 函数返回的也是对象生成的 VNode 对象；
  - ·template·：一个模板字符串，和在·Vue·文件里写的`template`是一样的，只是变成模板字符串的形式，这个属性会被`render`函数覆盖；

> 写一些测试代码来看看上面的描述是否正确；

```js
import Vue from 'vue';
import App from './App.vue';

Vue.config.productionTip = false;

// 这段是抄element-ui里的一个工具函数，用于判断是不是VNode对象
function isVNode(node) {
  return node !== null && typeof node === 'object' && Object.prototype.hasOwnProperty.call(node, 'componentOptions');
}
// 一个对象，false
console.warn(App, isVNode(App));

const app = new Vue({
  render: h => {
    const vnode = h(app);
    // 一个VNode对象，true
    console.warn(vnode, isVNode(vnode));
    return h(App);
  }
});
console.warn(app);
app.$mount('#app');
```

### Vue 实例

`new Vue`的返回值很明显是一个组件实例了，而在·main.js·里的就是根实例；

根实例上包含所有的[Vue 实例上的属性及方法](https://cn.vuejs.org/v2/api/#%E5%AE%9E%E4%BE%8B-property)；所以可以调用`$mount`方法，挂载在一个已存在的DOM元素上；
